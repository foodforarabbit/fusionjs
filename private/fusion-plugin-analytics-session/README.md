# @uber/fusion-plugin-analytics-session

[![Build status](https://badge.buildkite.com/e962e49f800a98e953516b0d036bc66501ccb5e90dcd7eff2f.svg?branch=master)](https://buildkite.com/uber/fusionjs)

Generates and provides analytics sessions data - such as id, timestamp - in cookies.

---

### Table of contents

- [Installation](#installation)
- [Usage](#usage)
- [Setup](#setup)
- [API](#api)
  - [Registration API](#registration-api)
    - [`AnalyticsSession`](#analyticssession)
    - [`AnalyticsSessionToken`](#analyticssessiontoken)
  - [Dependencies](#dependencies)
    - [`AnalyticsCookieTypeToken`](#analyticscookietypetoken)
    - [`UberWebEventCookie`](#uberwebeventcookie)

---

### Installation

```
yarn add @uber/fusion-plugin-analytics-session
```

---

### Usage

`.from(ctx)` returns the cookie value, or the first cookie value if `AnalyticsCookieTypeToken` is registered with` Array<CookieType>`

```js
app.middleware({sessionCookie: AnalyticsSessionToken}, ({sessionCookie}) => {
  return (ctx, next) => {
    const {session_id, session_time_ms} = sessionCookie.from(ctx);
    return next();
  }
});
```

`._from(ctx)` returns the [service instance](#service-api)
```js
app.middleware({sessionCookie: AnalyticsSessionToken}, ({sessionCookie}) => {
  return (ctx, next) => {
    const session = sessionCookie._from(ctx);
    const {session_id, session_time_ms} = sessionCookie.get(UberWebEventCookie);
    return next();
  }
});
```

---

### Setup

```js
// main.js
import AnalyticsSession, {UberWebEventCookie, AnalyticsCookieTypeToken, AnalyticsSessionToken} from 'fusion-plugin-analytics-session';
import App from 'fusion-react';
import MyPlugin from './plugins/my-plugin';

export default function start() {
  const app = new App(root);

  app.register(AnalyticsSessionToken, AnalyticsSession);
  app.register(AnalyticsCookieTypeToken, UberWebEventCookie);
  // or
  // app.register(AnalyticsCookieTypeToken, [UberWebEventCookie, SomeCookieType...]);

  return app;
}
```

---

### API

#### Registration API

##### `AnalyticsSession`

The plugin. It should be registered to [`AnalyticsSessionToken`](#analyticssessiontoken)

##### `AnalyticsSessionToken`

Should be registered with the [`AnalyticsSession`](#analyticssession) plugin

#### Dependencies

##### `AnalyticsCookieTypeToken`

A cookie configuration type object, or __an array of__. `CookieType | Array<CookieType>`

 Should be registered with [`UberWebEventCookie`](#uberwebeventcookie)

⚠️ if not explictly set `options.httpOnly` as `false`, the cookie is not accessible in the browser.

###### Types

```flow
type CookieType = {
  name: string,
  options?: $Shape<CookiesSetOptions>,
  data?: {
    session_id?: Symbol | string,
    session_time_ms?: Symbol | string,
  },
  rolling?: boolean,
};
```

- `name: string` - The cookie name
- `options` except for the options below, refer to [pillarjs/cookies](https://github.com/pillarjs/cookies)
  - `expires: number` - cookie expires (in milliseconds)
- `data`
  - `session_id: string` - unique session ID. Autogenerated
  - `session_time_ms: Date` - timestamp. Autogenerated
- `rolling: boolean` - continue to update the expiry as the user is browsing

##### `UberWebEventCookie`

A value of type `CookieType`

```js
{
  name: '_ua',
  options: {
    httpOnly: false
  },
  data: {
    session_id: CookieDataTypes.UUID, // autogenerated
    session_time_ms: CookieDataTypes.TIME_STAMP, // autogenerated
  },
}
```

#### Service API

For backward-compatibility,  `Plugin.from(ctx)` was defined to return the generated cookie value, or the first cookie value if `AnalyticsCookieTypeToken` is registered with` Array<CookieType>`.

The service is [request-scoped](https://fusionjs.com/api/fusion-core#memoization), to access the service, instantiate via `Plugin._from(ctx)`.

see [Usage](#usage) for exmaples differentiate `.from(ctx)` and `._from(ctx)`.

The following is the API for service instances intantiated via __`._from(ctx)`__

- `sessionCookie.refreshCookie(cookieType)` **server-only**

Generates the cookie for the response if the cookie doesn't exist in request or updates expiry if applicable.

- `sessionCookie.refreshCookies()` **server-only**

`.refreshCookie()` for all the `CookieType`s registered with `AnalyticsCookieTypeToken`

- `sessionCookie.set(cookieType?: CookieType, data: any)` **server-only**

Set/override the cookie value based on `cookieType.name`. It also extends expiry if `cookieType.options.expires` is presented.

- `sessionCookie.get(cookieType?: CookieType)` **universal**

Get the generated cookie value for a given cookieType.
If no cookieType was given, it defaults to the what's registered with `AnalyticsCookieTypeToken` (Object), or the first type in an `Array<CookieType>`.
